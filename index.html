<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Daftar Nilai EBTAQ v2</title>
    <style>
        /* Ukuran Kertas F4 (215mm x 330mm) */
        @page { size: 215mm 330mm; margin: 0; }
        body { 
            margin: 0; padding: 0; background-color: #525659; 
            font-family: "Times New Roman", serif; 
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* ================= PANEL KONTROL ================= */
        .control-panel {
            background: #fff; width: 215mm; margin: 20px auto;
            padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: block; box-sizing: border-box;
        }
        .control-panel h3 { margin: 0 0 15px; color: #007bff; font-family: Arial; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .row { display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-end; }
        .group { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 11px; font-weight: bold; font-family: Arial; color: #555; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        
        .btn-action { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: #fff; font-size: 14px; }
        .btn-gen { background: #28a745; }
        .btn-print { background: #007bff; display: none; }

        /* ================= TEMPLATE DAFTAR NILAI ================= */
        .page-result {
            width: 215mm; min-height: 330mm; margin: 10mm auto;
            background-color: white; padding: 1.5cm; box-sizing: border-box;
            position: relative;
        }
        .header-title { text-align: center; font-size: 16pt; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
        .header-date { text-align: center; font-size: 12pt; margin-bottom: 20px; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid black; padding: 6px; font-size: 10pt; text-align: center; }
        th { background-color: #f2f2f2; font-weight: bold; }
        .text-left { text-align: left; padding-left: 8px; }

        /* LOGIKA WARNA SESUAI INSTRUKSI */
        .red-text { color: red !important; font-weight: bold; }
        .red-row { background-color: #ffe6e6 !important; }
        .red-row td { color: red !important; border: 1px solid #ffcccc; }

        @media print {
            body { background: none; padding: 0; }
            .control-panel { display: none !important; }
            .page-result { margin: 0; box-shadow: none; width: 100%; }
        }
    </style>
</head>
<body>

<div class="control-panel">
    <h3>PANEL KONTROL DAFTAR NILAI EBTAQ</h3>
    <div class="row">
        <div class="group">
            <label>1. Upload CSV Nilai</label>
            <input type="file" id="csv-input" accept=".csv" onchange="processCSV()">
        </div>
        <div class="group">
            <label>2. Pilih Lembaga</label>
            <select id="sel-lembaga" disabled onchange="updateTitle()">
                <option value="">-- Pilih Lembaga --</option>
            </select>
        </div>
        <div class="group">
            <label>3. Tanggal Laporan</label>
            <input type="date" id="report-date">
        </div>
    </div>
    <div class="row">
        <button class="btn-action btn-gen" onclick="generateTable()">Tampilkan Daftar Nilai</button>
        <button id="print-btn" class="btn-action btn-print" onclick="window.print()">Unduh PDF / Cetak</button>
    </div>
</div>

<div id="render-area"></div>

<script>
    let rawData = [];
    const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const days = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];

    window.onload = () => {
        document.getElementById('report-date').valueAsDate = new Date();
    };

    function processCSV() {
        const file = document.getElementById('csv-input').files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split(/\r?\n/).filter(l => l.trim() !== "");
            // Headers diproses menjadi Uppercase untuk konsistensi pencarian
            const headers = lines[0].split(';').map(h => h.replace(/"/g, '').trim().toUpperCase());
            
            rawData = lines.slice(1).map(line => {
                const cols = line.split(';').map(c => c.replace(/"/g, '').trim());
                let obj = {};
                cols.forEach((v, i) => { if(headers[i]) obj[headers[i]] = v; });
                return obj;
            });

            const schools = [...new Set(rawData.map(d => d['ASAL LEMBAGA']))].sort();
            const sel = document.getElementById('sel-lembaga');
            sel.innerHTML = '<option value="">-- Pilih Lembaga --</option>';
            schools.forEach(s => { sel.innerHTML += `<option value="${s}">${s}</option>`; });
            sel.disabled = false;
        };
        reader.readAsText(file);
    }

    function updateTitle() {
        const sch = document.getElementById('sel-lembaga').value;
        document.title = "Daftar Nilai - " + sch;
    }

    function formatTitleCase(str) {
        if (!str) return "-";
        return str.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
    }

    function getFormattedDate(val) {
        const d = new Date(val);
        return `${days[d.getDay()]}, ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
    }

    function generateTable() {
        const sch = document.getElementById('sel-lembaga').value;
        if(!sch) return alert("Pilih lembaga terlebih dahulu!");

        const filtered = rawData.filter(d => d['ASAL LEMBAGA'] === sch);
        const reportDate = getFormattedDate(document.getElementById('report-date').value);
        
        const area = document.getElementById('render-area');
        area.innerHTML = `
            <div class="page-result">
                <div class="header-title">TPQ ${sch}</div>
                <div class="header-date">${reportDate}</div>
                <table>
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>Nama Lengkap</th>
                            <th>N. FSH</th>
                            <th>N. GRB</th>
                            <th>N. TRL</th>
                            <th>N. TJW</th>
                            <th>N. DDH</th>
                            <th>N. SSP</th>
                            <th>N. SLT</th>
                            <th>N. WDL</th>
                            <th>L/TL</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        `;

        const body = document.getElementById('table-body');
        filtered.forEach((d, idx) => {
            // Pengambilan status dari header "L / TL" sesuai instruksi
            const statusVal = d['L / TL'] || d['L/TL'] || "-";
            const isTL = statusVal === "TL";
            const rowClass = isTL ? 'class="red-row"' : '';
            
            let rowHtml = `<tr ${rowClass}>
                <td>${idx + 1}</td>
                <td class="text-left">${formatTitleCase(d['NAMA LENGKAP'])}</td>`;
            
            // Kolom nilai sesuai PDF 
            const scoreKeys = ['N. FSH', 'N. GRB', 'N. TRL', 'N. TJW', 'N. DDH', 'N. SSP', 'N. SLT', 'N. WDL'];
            
            scoreKeys.forEach(key => {
                let displayVal = d[key] || "0";
                // Konversi koma ke titik untuk pengecekan numerik
                let num = parseFloat(displayVal.replace(',', '.'));
                
                // Merahkan teks jika nilai < 6 (angka 6 tetap hitam)
                let cellClass = (num < 6) ? 'class="red-text"' : '';
                rowHtml += `<td ${cellClass}>${displayVal}</td>`;
            });

            // Kolom L/TL (Merah jika TL)
            const statusClass = isTL ? 'class="red-text"' : '';
            rowHtml += `<td ${statusClass}>${statusVal}</td></tr>`;
            
            body.innerHTML += rowHtml;
        });

        document.getElementById('print-btn').style.display = 'block';
    }
</script>
</body>
</html>
