<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Sistem Daftar Nilai EBTAQ</title>
    <style>
        @page { size: A4; margin: 1cm; }
        body { font-family: Arial, sans-serif; background-color: #525659; margin: 0; padding: 0; }

        /* ================= PANEL KONTROL ================= */
        .control-panel {
            background: #fff; width: 210mm; margin: 20px auto;
            padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .row { display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-end; }
        .group { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 12px; font-weight: bold; color: #555; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        .btn-action { 
            padding: 10px 20px; border: none; border-radius: 4px; 
            cursor: pointer; font-weight: bold; color: #fff;
        }
        .btn-gen { background: #28a745; }
        .btn-print { background: #007bff; display: none; }

        /* ================= TEMPLATE NILAI ================= */
        .page-result {
            width: 210mm; min-height: 297mm; margin: 20px auto;
            background-color: white; padding: 1.5cm; box-sizing: border-box;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .header-title { text-align: center; font-size: 16pt; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; }
        .header-date { text-align: center; font-size: 12pt; margin-bottom: 25px; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid black; padding: 6px; font-size: 10pt; text-align: center; }
        th { background-color: #f2f2f2; }
        .text-left { text-align: left; }

        /* LOGIKA WARNA */
        .red-text { color: red; font-weight: bold; }
        .red-row { background-color: #ffe6e6 !important; }
        .red-row td { color: red !important; }

        @media print {
            body { background: none; }
            .control-panel { display: none; }
            .page-result { margin: 0; box-shadow: none; width: 100%; }
        }
    </style>
</head>
<body>

<div class="control-panel">
    <h3>PANEL KONTROL DAFTAR NILAI</h3>
    <div class="row">
        <div class="group">
            <label>1. Upload CSV Nilai</label>
            <input type="file" id="csv-input" accept=".csv" onchange="processCSV()">
        </div>
        <div class="group">
            <label>2. Pilih Lembaga</label>
            <select id="sel-lembaga" disabled onchange="toggleBtn()">
                <option value="">-- Pilih Lembaga --</option>
            </select>
        </div>
        <div class="group">
            <label>3. Tanggal Laporan</label>
            <input type="date" id="report-date">
        </div>
    </div>
    <div class="row">
        <button class="btn-action btn-gen" onclick="generateTable()">Tampilkan Data</button>
        <button id="print-btn" class="btn-action btn-print" onclick="window.print()">Unduh PDF / Cetak</button>
    </div>
</div>

<div id="render-area"></div>

<script>
    let rawData = [];
    const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const days = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];

    window.onload = () => {
        document.getElementById('report-date').valueAsDate = new Date();
    };

    function processCSV() {
        const file = document.getElementById('csv-input').files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split(/\r?\n/).filter(l => l.trim() !== "");
            const headers = lines[0].split(';').map(h => h.replace(/"/g, '').trim().toUpperCase());
            
            rawData = lines.slice(1).map(line => {
                const cols = line.split(';').map(c => c.replace(/"/g, '').trim());
                let obj = {};
                cols.forEach((v, i) => { if(headers[i]) obj[headers[i]] = v; });
                return obj;
            });

            const schools = [...new Set(rawData.map(d => d['ASAL LEMBAGA']))].sort();
            const sel = document.getElementById('sel-lembaga');
            sel.innerHTML = '<option value="">-- Pilih Lembaga --</option>';
            schools.forEach(s => { sel.innerHTML += `<option value="${s}">${s}</option>`; });
            sel.disabled = false;
        };
        reader.readAsText(file);
    }

    function toggleBtn() {
        document.title = "Daftar Nilai - " + document.getElementById('sel-lembaga').value;
    }

    function formatDate(val) {
        const d = new Date(val);
        return `${days[d.getDay()]}, ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
    }

    function generateTable() {
        const sch = document.getElementById('sel-lembaga').value;
        if(!sch) return alert("Pilih lembaga!");

        const filtered = rawData.filter(d => d['ASAL LEMBAGA'] === sch);
        const reportDate = formatDate(document.getElementById('report-date').value);
        
        const area = document.getElementById('render-area');
        area.innerHTML = `
            <div class="page-result">
                <div class="header-title">TPQ ${sch}</div>
                <div class="header-date">${reportDate}</div>
                <table>
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>Nama Lengkap</th>
                            <th>N. FSH</th>
                            <th>N. GRB</th>
                            <th>N. TRL</th>
                            <th>N. TJW</th>
                            <th>N. DDH</th>
                            <th>N. SSP</th>
                            <th>N. SLT</th>
                            <th>N. WDL</th>
                            <th>L/TL</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        `;

        const body = document.getElementById('table-body');
        filtered.forEach((d, idx) => {
            const isTL = d['L/TL'] === "TL";
            const rowClass = isTL ? 'class="red-row"' : '';
            
            let rowHtml = `<tr ${rowClass}>
                <td>${idx + 1}</td>
                <td class="text-left">${d['NAMA LENGKAP']}</td>`;
            
            // Kolom nilai (N. FSH s.d N. WDL)
            const scoreKeys = ['N. FSH', 'N. GRB', 'N. TRL', 'N. TJW', 'N. DDH', 'N. SSP', 'N. SLT', 'N. WDL'];
            
            scoreKeys.forEach(key => {
                let val = d[key] ? d[key].replace(',', '.') : "0";
                let num = parseFloat(val);
                let displayVal = d[key] || "-";
                
                // Merahkan jika < 6 (6 tetap hitam)
                let cellClass = (num < 6) ? 'class="red-text"' : '';
                rowHtml += `<td ${cellClass}>${displayVal}</td>`;
            });

            // Kolom L/TL
            const statusClass = isTL ? 'class="red-text"' : '';
            rowHtml += `<td ${statusClass}>${d['L/TL'] || "-"}</td></tr>`;
            
            body.innerHTML += rowHtml;
        });

        document.getElementById('print-btn').style.display = 'block';
    }
</script>
</body>
</html>
