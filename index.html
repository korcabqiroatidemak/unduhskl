<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SKL EBTAQ</title>
    <style>
        @page { size: 215mm 330mm; margin: 1cm; }
        body { 
            margin: 0; padding: 0; background-color: #525659; 
            font-family: "Times New Roman", serif; 
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
        }

        /* ================= PANEL KONTROL ================= */
        .control-panel {
            background: #fff; width: 215mm; margin: 20px auto;
            padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .row { display: flex; gap: 15px; margin-bottom: 15px; align-items: flex-end; }
        .group { flex: 1; display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 11px; font-weight: bold; font-family: Arial; color: #555; }
        input, select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        .btn-action { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: #fff; font-size: 14px; }
        .btn-gen { background: #28a745; }
        .btn-print { background: #007bff; display: none; }

        /* ================= KANVAS LAPORAN ================= */
        .page-result {
            width: 215mm; min-height: 330mm; margin: 0mm auto;
            background-color: white; padding: 1.5cm; box-sizing: border-box;
        }
        .header-title { text-align: center; font-size: 16pt; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
        .header-date { text-align: center; font-size: 12pt; margin-bottom: 20px; }

        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid black; padding: 5px; font-size: 10pt; text-align: center; }
        th { background-color: #f2f2f2; font-weight: bold; }
        .text-left { text-align: left; padding-left: 8px; }

        /* LOGIKA WARNA */
        .red-text { color: red !important; font-weight: bold; }
        .red-row { background-color: #ffe6e6 !important; }
        .red-row td { color: red !important; }

        /* REKAP & JUARA SECTION */
        .rekap-section { margin-top: 30px; display: flex; gap: 20px; flex-wrap: wrap; }
        .box-info { flex: 1; min-width: 300px; border: 1px solid #000; padding: 10px; }
        .box-title { font-weight: bold; border-bottom: 1px solid #000; margin-bottom: 10px; text-transform: uppercase; font-size: 11pt; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 10pt; }

        @media print {
            body { background: none; padding: 0; }
            .control-panel { display: none !important; }
            .page-result { margin: 0; box-shadow: none; width: 100%; }
        }
    </style>
</head>
<body>

<div class="control-panel">
    <h3>PANEL KONTROL DAFTAR NILAI (v5)</h3>
    <div class="row">
        <div class="group">
            <label>1. Upload CSV Nilai</label>
            <input type="file" id="csv-input" accept=".csv" onchange="processCSV()">
        </div>
        <div class="group">
            <label>2. Pilih Lembaga</label>
            <select id="sel-lembaga" disabled onchange="updateTitle()">
                <option value="">-- Pilih Lembaga --</option>
            </select>
        </div>
        <div class="group">
            <label>3. Tanggal Laporan</label>
            <input type="date" id="report-date">
        </div>
    </div>
    <div class="row">
        <button class="btn-action btn-gen" onclick="generateTable()">Proses Data & Analisa</button>
        <button id="print-btn" class="btn-action btn-print" onclick="window.print()">Simpan Ke PDF</button>
    </div>
</div>

<div id="render-area"></div>

<script>
    let rawData = [];
    let globalAvg = 0;
    const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    const days = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
    const scoreKeys = ['N. FSH', 'N. TRL', 'N. TJW', 'N. GRB', 'N. DDH', 'N. SSP', 'N. SLT', 'N. WDL'];

    window.onload = () => {
        document.getElementById('report-date').value = new Date().toISOString().split('T')[0];
    };

    function processCSV() {
        const file = document.getElementById('csv-input').files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const lines = e.target.result.split(/\r?\n/).filter(l => l.trim() !== "");
            const headers = lines[0].split(';').map(h => h.replace(/"/g, '').trim().toUpperCase());
            
            rawData = lines.slice(1).map(line => {
                const cols = line.split(';').map(c => c.replace(/"/g, '').trim());
                let obj = {};
                cols.forEach((v, i) => { if(headers[i]) obj[headers[i]] = v; });
                
                // Hitung Rata-rata Akhir per siswa untuk keperluan sorting
                let sum = 0;
                scoreKeys.forEach(k => sum += parseFloat((obj[k]||"0").replace(',','.')) || 0);
                obj._avg = sum / scoreKeys.length;
                
                // Hitung Rata-rata 4 Mapel Utama (FSH, TRL, TJW, GRB)
                let sum4 = 0;
                ['N. FSH', 'N. TRL', 'N. TJW', 'N. GRB'].forEach(k => sum4 += parseFloat((obj[k]||"0").replace(',','.')) || 0);
                obj._avg4 = sum4 / 4;
                obj._fsh = parseFloat((obj['N. FSH']||"0").replace(',','.'));

                return obj;
            });

            // Hitung Rata-rata Global (Semua Lembaga)
            const validData = rawData.filter(d => d._avg > 0);
            globalAvg = validData.reduce((a, b) => a + b._avg, 0) / validData.length;

            const schools = [...new Set(rawData.map(d => d['ASAL LEMBAGA']))].sort();
            const sel = document.getElementById('sel-lembaga');
            sel.innerHTML = '<option value="">-- Pilih Lembaga --</option>';
            schools.forEach(s => { sel.innerHTML += `<option value="${s}">${s}</option>`; });
            sel.disabled = false;
        };
        reader.readAsText(file);
    }

    function formatTitleCase(str) {
        return str ? str.toLowerCase().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') : "-";
    }

    function generateTable() {
        const sch = document.getElementById('sel-lembaga').value;
        if(!sch) return alert("Pilih lembaga!");

        const list = rawData.filter(d => d['ASAL LEMBAGA'] === sch);
        const reportDate = document.getElementById('report-date').value;
        const dObj = new Date(reportDate);
        const tglFull = `${days[dObj.getDay()]}, ${dObj.getDate()} ${months[dObj.getMonth()]} ${dObj.getFullYear()}`;

        // ANALISA REKAPITULASI
        const totalPeserta = list.length;
        const lulus = list.filter(d => (d['L / TL'] || d['L/TL']) === "L").length;
        const tLulus = totalPeserta - lulus;
        const persenLulus = ((lulus/totalPeserta)*100).toFixed(1);
        const avgLembaga = list.reduce((a,b) => a + b._avg, 0) / totalPeserta;

        // ANALISA JUARA (HANYA L)
        const candidates = list.filter(d => (d['L / TL'] || d['L/TL']) === "L")
            .sort((a, b) => b._avg - a._avg || b._avg4 - a._avg4 || b._fsh - a._fsh);

        let html = `
            <div class="page-result">
                <div class="header-title">${sch}</div>
                <div class="header-date">${tglFull}</div>
                <table>
                    <thead>
                        <tr>
                            <th>No.</th><th>Nama Lengkap</th>
                            ${scoreKeys.map(k => `<th>${k}</th>`).join('')}
                            <th>L/TL</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${list.map((d, i) => {
                            const isTL = (d['L / TL'] || d['L/TL']) === "TL";
                            return `<tr class="${isTL ? 'red-row' : ''}">
                                <td>${i+1}</td>
                                <td class="text-left">${formatTitleCase(d['NAMA LENGKAP'])}</td>
                                ${scoreKeys.map(k => {
                                    const val = parseFloat((d[k]||"0").replace(',','.'));
                                    return `<td class="${val < 6 ? 'red-text' : ''}">${d[k]||'0'}</td>`;
                                }).join('')}
                                <td class="${isTL ? 'red-text' : ''}">${d['L / TL'] || d['L/TL'] || '-'}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>

                <div class="rekap-section">
                    <div class="box-info">
                        <div class="box-title">Rekapitulasi Kelulusan</div>
                        <div class="info-row"><span>Jumlah Peserta</span> <span>: ${totalPeserta}</span></div>
                        <div class="info-row"><span>Lulus</span> <span>: ${lulus}</span></div>
                        <div class="info-row"><span>Tidak Lulus</span> <span>: ${tLulus}</span></div>
                        <div class="info-row"><span>Persentase</span> <span>: ${persenLulus}%</span></div>
                        <div class="info-row" style="margin-top:10px; font-weight:bold; border-top:1px dashed #ccc;">
                            <span>Rata-rata Lembaga</span> <span>: ${avgLembaga.toFixed(2)}</span>
                        </div>
                        <div class="info-row"><span>Rata-rata Global (CSV)</span> <span>: ${globalAvg.toFixed(2)}</span></div>
                    </div>

                    <div class="box-info">
                        <div class="box-title">Prestasi Siswa (Juara)</div>
                        ${candidates.length > 0 ? candidates.slice(0,3).map((c, i) => `
                            <div class="info-row">
                                <span>Juara ${['I','II','III'][i]} a.n. ${formatTitleCase(c['NAMA LENGKAP'])}</span>
                                <span>Rata-rata: ${c._avg.toFixed(2)}</span>
                            </div>
                        `).join('') : '<div class="info-row">Tidak ada data juara (Tidak ada yang lulus)</div>'}
                    </div>

                    <div class="box-info" style="flex:2">
                        <div class="box-title">Analisa Materi & Kualitas</div>
                        <table>
                            <thead><tr><th>Materi</th><th>Avg Lembaga</th><th>Status</th></tr></thead>
                            <tbody>
                                ${scoreKeys.map(k => {
                                    const mAvg = list.reduce((a,b) => a + parseFloat((b[k]||"0").replace(',','.')), 0) / totalPeserta;
                                    return `<tr>
                                        <td>${k}</td>
                                        <td class="${mAvg < 6 ? 'red-text' : ''}">${mAvg.toFixed(2)}</td>
                                        <td>${mAvg < 6 ? 'PERLU REMIDIAL' : 'TUNTAS'}</td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
        
        document.getElementById('render-area').innerHTML = html;
        document.getElementById('print-btn').style.display = 'block';
    }

    function updateTitle() {
        document.title = "Hasil EBTAQ - " + document.getElementById('sel-lembaga').value;
    }
</script>
</body>
</html>
